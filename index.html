<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Telegram Christmass</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico" />
    <link rel="stylesheet" href="TemplateData/style.css" />

    <!-- ‚úÖ Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π unlock –∞—É–¥—ñ–æ + Telegram expand -->
    <script>
      (function () {
        let unlocked = false;

        // üîä –†–æ–±–∏–º–æ –≥–ª–æ–±–∞–ª—å–Ω–∏–º
        window.unlockAudioContext = async function () {
          try {
            const AudioCtx = window.AudioContext || window.webkitAudioContext;
            if (!AudioCtx) return;
            if (!window._unityAudioCtx) window._unityAudioCtx = new AudioCtx();

            const ctx = window._unityAudioCtx;
            if (ctx.state === "suspended") await ctx.resume();

            if (
              typeof unityInstance !== "undefined" &&
              unityInstance?.Module?.resumeAudioContext
            )
              unityInstance.Module.resumeAudioContext();

            console.log("üéµ Audio resumed");
          } catch (e) {
            console.warn("Audio unlock error:", e);
          }
        };

        function onFirstGesture() {
          if (unlocked) return;
          unlocked = true;
          unlockAudioContext();
          document.removeEventListener("touchstart", onFirstGesture);
          document.removeEventListener("click", onFirstGesture);
        }
        document.addEventListener("touchstart", onFirstGesture, { once: true });
        document.addEventListener("click", onFirstGesture, { once: true });

        document.addEventListener("visibilitychange", () => {
          if (!document.hidden) {
            console.log("üîÅ Page visible again ‚Äî resuming audio...");
            unlockAudioContext();
          }
        });

        setInterval(() => {
          if (
            window._unityAudioCtx &&
            window._unityAudioCtx.state === "suspended"
          ) {
            console.log("üîÑ Detected suspended context ‚Äî trying to resume...");
            unlockAudioContext();
          }
        }, 3000);

        window.addEventListener("DOMContentLoaded", () => {
          if (window.Telegram?.WebApp) {
            try {
              window.Telegram.WebApp.expand();
              console.log("üñ•Ô∏è Telegram WebApp expanded to full screen");
            } catch (e) {
              console.warn("‚ö†Ô∏è Telegram expand failed:", e);
            }
          }
        });
      })();
    </script>
  </head>

  <body>
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
    </div>

    <script>
      const canvas = document.querySelector("#unity-canvas");
      const buildUrl = "Build";
      const loaderUrl = buildUrl + "/Telegram-Christmass-Build.loader.js";

      const config = {
        dataUrl: buildUrl + "/Telegram-Christmass-Build.data",
        frameworkUrl: buildUrl + "/Telegram-Christmass-Build.framework.js",
        codeUrl: buildUrl + "/Telegram-Christmass-Build.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "Telegram Christmass",
        productVersion: "0.0.3",
      };

      // üì± –ú–æ–±—ñ–ª—å–Ω–∞ –∞–¥–∞–ø—Ç–∞—Ü—ñ—è
      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        const meta = document.createElement("meta");
        meta.name = "viewport";
        meta.content =
          "width=device-width, height=device-height, initial-scale=1.0, user-scalable=no";
        document.head.appendChild(meta);
        document.querySelector("#unity-container").className = "unity-mobile";
        canvas.className = "unity-mobile";
      }

      document.querySelector("#unity-loading-bar").style.display = "block";

      // üì¶ –ù–∞–¥—ñ–π–Ω–µ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è Telegram –¥–∞–Ω–∏—Ö
      async function waitForTelegramData(unityInstance, timeoutMs = 7000) {
        if (!window.Telegram || !Telegram.WebApp) {
          unityInstance.SendMessage(
            "AuthProgressTextHandler",
            "ReceiveMessage",
            "‚ùå Telegram WebApp not found."
          );
          console.warn("‚ùå Telegram WebApp not found.");
          return false;
        }

        const webApp = Telegram.WebApp;
        try {
          webApp.ready();
          webApp.expand();
          unityInstance.SendMessage(
            "AuthProgressTextHandler",
            "ReceiveMessage",
            "‚úÖ Telegram WebApp ready..."
          );
        } catch (e) {
          console.warn("Telegram ready/expand failed:", e);
        }

        const start = Date.now();
        while (Date.now() - start < timeoutMs) {
          const data = webApp.initDataUnsafe;
          if (data && (data.user || data.hash)) {
            console.log("‚úÖ Telegram initDataUnsafe received:", data);
            unityInstance.SendMessage(
              "TelegramAuthHandler",
              "OnTelegramAuth",
              JSON.stringify(data)
            );
            unityInstance.SendMessage(
              "AuthProgressTextHandler",
              "ReceiveMessage",
              "‚úÖ Telegram data received and sent to Unity."
            );
            return true;
          }

          unityInstance.SendMessage(
            "AuthProgressTextHandler",
            "ReceiveMessage",
            "‚è≥ Waiting for Telegram data..."
          );
          await new Promise((r) => setTimeout(r, 300));
        }

        unityInstance.SendMessage(
          "AuthProgressTextHandler",
          "ReceiveMessage",
          "‚ùå Telegram data not received (timeout)."
        );
        console.warn("‚ùå Telegram data empty after timeout");
        return false;
      }

      // üß© Unity —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è
      const script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          document.querySelector("#unity-progress-bar-full").style.width =
            100 * progress + "%";
        })
          .then(async (unityInstance) => {
            document.querySelector("#unity-loading-bar").style.display = "none";

            const gotData = await waitForTelegramData(unityInstance, 7000);
            if (!gotData) {
              console.warn("‚ö†Ô∏è Telegram data not received ‚Äî maybe opened outside Telegram.");
            }

            // üîà –ü—Ä–æ–±—É–¥–∂–µ–Ω–Ω—è –∞—É–¥—ñ–æ
            setTimeout(() => {
              if (typeof unlockAudioContext === "function") unlockAudioContext();
            }, 800);
          })
          .catch(alert);
      };
      document.body.appendChild(script);
    </script>
  </body>
</html>
