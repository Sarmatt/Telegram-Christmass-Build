<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Telegram Christmass</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico" />
    <link rel="stylesheet" href="TemplateData/style.css" />

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        background-color: #000;
      }

      #unity-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      #unity-canvas {
        width: 100%;
        height: 100%;
        background: #000;
        display: block;
      }

      #unity-loading-bar {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 60%;
        height: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        overflow: hidden;
      }

      #unity-progress-bar-full {
        width: 0%;
        height: 100%;
        background: #fff;
        transition: width 0.2s;
      }
    </style>

    <!-- ‚úÖ Telegram SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π unlock –∞—É–¥—ñ–æ + Telegram expand -->
    <script>
      (function () {
        let unlocked = false;

        // üîä –ì–ª–æ–±–∞–ª—å–Ω–∏–π –∞—É–¥—ñ–æ unlock
        window.unlockAudioContext = async function () {
          try {
            const AudioCtx = window.AudioContext || window.webkitAudioContext;
            if (!AudioCtx) return;
            if (!window._unityAudioCtx) window._unityAudioCtx = new AudioCtx();

            const ctx = window._unityAudioCtx;
            if (ctx.state === "suspended") await ctx.resume();

            if (
              typeof unityInstance !== "undefined" &&
              unityInstance?.Module?.resumeAudioContext
            )
              unityInstance.Module.resumeAudioContext();

            console.log("üéµ Audio resumed");
          } catch (e) {
            console.warn("Audio unlock error:", e);
          }
        };

        function onFirstGesture() {
          if (unlocked) return;
          unlocked = true;
          unlockAudioContext();
          document.removeEventListener("touchstart", onFirstGesture);
          document.removeEventListener("click", onFirstGesture);
        }

        document.addEventListener("touchstart", onFirstGesture, { once: true });
        document.addEventListener("click", onFirstGesture, { once: true });

        document.addEventListener("visibilitychange", () => {
          if (!document.hidden) {
            console.log("üîÅ Page visible again ‚Äî resuming audio...");
            unlockAudioContext();
          }
        });

        setInterval(() => {
          if (
            window._unityAudioCtx &&
            window._unityAudioCtx.state === "suspended"
          ) {
            console.log("üîÑ Detected suspended context ‚Äî trying to resume...");
            unlockAudioContext();
          }
        }, 3000);

        window.addEventListener("DOMContentLoaded", () => {
          if (window.Telegram?.WebApp) {
            try {
              window.Telegram.WebApp.expand();
              console.log("üñ•Ô∏è Telegram WebApp expanded to full screen");
            } catch (e) {
              console.warn("‚ö†Ô∏è Telegram expand failed:", e);
            }

            // üîÅ –ü–æ–≤—Ç–æ—Ä–Ω–∞ —Å–ø—Ä–æ–±–∞ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è (–¥–µ—è–∫—ñ –≤–µ—Ä—Å—ñ—ó Desktop —ñ–≥–Ω–æ—Ä—É—é—Ç—å –ø–µ—Ä—à—É)
            setTimeout(() => {
              try {
                window.Telegram?.WebApp?.expand();
                console.log("üñ•Ô∏è Telegram expanded (retry)");
              } catch {}
            }, 1500);
          }
        });
      })();
    </script>
  </head>

  <body>
    <div id="unity-container">
      <canvas id="unity-canvas" tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-progress-bar-full"></div>
      </div>
    </div>

    <script>
      const canvas = document.querySelector("#unity-canvas");
      const buildUrl = "Build";
      const loaderUrl = buildUrl + "/Telegram-Christmass-Build.loader.js";

      const config = {
        dataUrl: buildUrl + "/Telegram-Christmass-Build.data",
        frameworkUrl: buildUrl + "/Telegram-Christmass-Build.framework.js",
        codeUrl: buildUrl + "/Telegram-Christmass-Build.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "Telegram Christmass",
        productVersion: "0.0.3",
      };

      document.querySelector("#unity-loading-bar").style.display = "block";

      // üì¶ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è Telegram –¥–∞–Ω–∏—Ö
      async function waitForTelegramData(unityInstance, timeoutMs = 7000) {
        if (!window.Telegram || !Telegram.WebApp) {
          unityInstance.SendMessage(
            "AuthProgressTextHandler",
            "ReceiveMessage",
            "‚ùå Telegram WebApp not found."
          );
          console.warn("‚ùå Telegram WebApp not found.");
          return false;
        }

        const webApp = Telegram.WebApp;
        try {
          webApp.ready();
          webApp.expand();
          unityInstance.SendMessage(
            "AuthProgressTextHandler",
            "ReceiveMessage",
            "‚úÖ Telegram WebApp ready..."
          );
        } catch (e) {
          console.warn("Telegram ready/expand failed:", e);
        }

        const start = Date.now();
        while (Date.now() - start < timeoutMs) {
          const data = webApp.initDataUnsafe;
          if (data && (data.user || data.hash)) {
            console.log("‚úÖ Telegram initDataUnsafe received:", data);
            unityInstance.SendMessage(
              "TelegramAuthHandler",
              "OnTelegramAuth",
              JSON.stringify(data)
            );
            unityInstance.SendMessage(
              "AuthProgressTextHandler",
              "ReceiveMessage",
              "‚úÖ Telegram data received and sent to Unity."
            );
            return true;
          }

          unityInstance.SendMessage(
            "AuthProgressTextHandler",
            "ReceiveMessage",
            "‚è≥ Waiting for Telegram data..."
          );
          await new Promise((r) => setTimeout(r, 300));
        }

        unityInstance.SendMessage(
          "AuthProgressTextHandler",
          "ReceiveMessage",
          "‚ùå Telegram data not received (timeout)."
        );
        console.warn("‚ùå Telegram data empty after timeout");
        return false;
      }

      // üß© –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Unity instance
      const script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          document.querySelector("#unity-progress-bar-full").style.width =
            100 * progress + "%";
        })
          .then(async (unityInstance) => {
            document.querySelector("#unity-loading-bar").style.display = "none";

            let telegramAvailable =
              typeof Telegram !== "undefined" && Telegram.WebApp;
            if (telegramAvailable) {
              const gotData = await waitForTelegramData(unityInstance, 7000);
              if (!gotData) {
                console.warn(
                  "‚ö†Ô∏è Telegram data not received ‚Äî maybe opened outside Telegram."
                );
              }
            } else {
              console.warn("‚ö†Ô∏è Telegram SDK not found ‚Äî running in browser fallback mode.");
              unityInstance.SendMessage(
                "AuthProgressTextHandler",
                "ReceiveMessage",
                "üåê Running outside Telegram (browser/desktop mode)."
              );

              // üß© –ú–æ–∫-–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
              const mockData = {
                user: { id: 0, first_name: "Guest", last_name: "", username: "BrowserUser" },
                hash: "mock_hash",
              };
              unityInstance.SendMessage(
                "TelegramAuthHandler",
                "OnTelegramAuth",
                JSON.stringify(mockData)
              );
            }

            // üîà –ü—Ä–æ–±—É–¥–∂–µ–Ω–Ω—è –∞—É–¥—ñ–æ –ø—ñ—Å–ª—è —Å—Ç–∞—Ä—Ç—É
            setTimeout(() => {
              if (typeof unlockAudioContext === "function") unlockAudioContext();
            }, 800);

            // ü™ü –†–µ—Å–∞–π–∑ –ø—ñ–¥ –≤—ñ–∫–Ω–æ
            function resizeCanvas() {
              canvas.width = window.innerWidth;
              canvas.height = window.innerHeight;
            }
            window.addEventListener("resize", resizeCanvas);
            resizeCanvas();
          })
          .catch(alert);
      };
      document.body.appendChild(script);
    </script>
  </body>
</html>
