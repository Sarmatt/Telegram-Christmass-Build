<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Telegram Christmass</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico" />
    <link rel="stylesheet" href="TemplateData/style.css" />

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        background-color: #000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #unity-container {
        position: relative;
        width: 1080px;
        height: 1920px;
        overflow: hidden;
        background: #000;
        box-shadow: 0 0 40px rgba(0, 0, 0, 0.6);
        border-radius: 20px;
      }

      #unity-canvas {
        width: 100%;
        height: 100%;
        display: block;
        background: #000;
      }

      #unity-loading-bar {
        position: absolute;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        width: 60%;
        height: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        overflow: hidden;
      }

      #unity-progress-bar-full {
        width: 0%;
        height: 100%;
        background: #fff;
        transition: width 0.2s;
      }

      /* üì± –ù–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É ‚Äî —Ñ—É–ª—Å–∫—Ä—ñ–Ω */
      @media (max-width: 1080px) {
        html, body {
          display: block;
        }
        #unity-container {
          width: 100vw;
          height: 100vh;
          border-radius: 0;
          box-shadow: none;
        }
      }
    </style>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
      (function () {
        let unlocked = false;
        window.unlockAudioContext = async function () {
          try {
            const AudioCtx = window.AudioContext || window.webkitAudioContext;
            if (!AudioCtx) return;
            if (!window._unityAudioCtx) window._unityAudioCtx = new AudioCtx();
            const ctx = window._unityAudioCtx;
            if (ctx.state === "suspended") await ctx.resume();
            if (typeof unityInstance !== "undefined" && unityInstance?.Module?.resumeAudioContext)
              unityInstance.Module.resumeAudioContext();
            console.log("üéµ Audio resumed");
          } catch (e) {
            console.warn("Audio unlock error:", e);
          }
        };

        function onFirstGesture() {
          if (unlocked) return;
          unlocked = true;
          unlockAudioContext();
          document.removeEventListener("touchstart", onFirstGesture);
          document.removeEventListener("click", onFirstGesture);
        }
        document.addEventListener("touchstart", onFirstGesture, { once: true });
        document.addEventListener("click", onFirstGesture, { once: true });

        document.addEventListener("visibilitychange", () => {
          if (!document.hidden) unlockAudioContext();
        });

        window.addEventListener("DOMContentLoaded", () => {
          if (window.Telegram?.WebApp) {
            try {
              window.Telegram.WebApp.expand();
              console.log("üñ•Ô∏è Telegram WebApp expanded");
            } catch {}
          }
        });
      })();
    </script>
  </head>

  <body>
    <div id="unity-container">
      <canvas id="unity-canvas" tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-progress-bar-full"></div>
      </div>
    </div>

    <script>
      const canvas = document.querySelector("#unity-canvas");
      const buildUrl = "Build";
      const loaderUrl = buildUrl + "/Telegram-Christmass-Build.loader.js";

      const config = {
        dataUrl: buildUrl + "/Telegram-Christmass-Build.data",
        frameworkUrl: buildUrl + "/Telegram-Christmass-Build.framework.js",
        codeUrl: buildUrl + "/Telegram-Christmass-Build.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "Telegram Christmass",
        productVersion: "0.0.3",
      };

      async function waitForTelegramData(unityInstance, timeoutMs = 7000) {
        if (!window.Telegram || !Telegram.WebApp) {
          unityInstance.SendMessage("AuthProgressTextHandler", "ReceiveMessage", "‚ùå Telegram WebApp not found.");
          return false;
        }

        const webApp = Telegram.WebApp;
        try {
          webApp.ready();
          webApp.expand();
        } catch (e) {}

        const start = Date.now();
        while (Date.now() - start < timeoutMs) {
          const data = webApp.initDataUnsafe;
          if (data && (data.user || data.hash)) {
            unityInstance.SendMessage("TelegramAuthHandler", "OnTelegramAuth", JSON.stringify(data));
            return true;
          }
          await new Promise((r) => setTimeout(r, 300));
        }

        return false;
      }

      const script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          document.querySelector("#unity-progress-bar-full").style.width = 100 * progress + "%";
        })
          .then(async (unityInstance) => {
            document.querySelector("#unity-loading-bar").style.display = "none";
            const gotData = await waitForTelegramData(unityInstance, 7000);
            if (!gotData) console.warn("‚ö†Ô∏è Telegram data not received.");

            setTimeout(() => {
              if (typeof unlockAudioContext === "function") unlockAudioContext();
            }, 800);
          })
          .catch(alert);
      };
      document.body.appendChild(script);
    </script>
  </body>
</html>
